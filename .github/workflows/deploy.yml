name: Deploy Discord Bot

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------- RUST ----------------
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Add WASI target
      run: rustup target add wasm32-wasip1

    # ---------------- INSTALL FLOWS CLI ----------------
    - name: Install flows CLI
      run: |
        curl -s https://api.github.com/repos/flows-network/flows-cli/releases/latest \
        | grep "browser_download_url.*linux" \
        | cut -d '"' -f 4 \
        | wget -i -

        chmod +x flows*
        sudo mv flows* /usr/local/bin/flows
        flows --version

    # ---------------- LOGIN TO FLOWS ----------------
    - name: Login to flows
      run: flows login --token ${{ secrets.FLOWS_TOKEN }}

    # ---------------- BUILD BOT ----------------
    - name: Build bot
      run: cargo build --release --target wasm32-wasip1

    # ---------------- DEPLOY ----------------
    - name: Deploy bot
      run: |
        flows deploy \
          --wasm target/wasm32-wasip1/release/chemistry-discord-bot.wasm \
          --name chemistry-discord-bot \
          --env DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }} \
          --env GAIA_NODE_URL=${{ secrets.GAIA_NODE_URL }}
